{
    "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
    "contentVersion": "1.0.0.0",
    "parameters": {
        "cosmosDbAccountName": {
            "type": "string",
            "metadata": {
                "description": "Name of the Azure Cosmos DB account (globally unique)."
            }
        },
        "location": {
            "type": "string",
            "metadata": {
                "description": "Primary Azure region for the Cosmos DB account."
            }
        },
        "secondaryLocations": {
            "type": "array",
            "defaultValue": [],
            "metadata": {
                "description": "(Optional) Array of secondary Azure regions for geo-replication. Example: [ { \"locationName\": \"West US\", \"failoverPriority\": 1 } ]"
            }
        },
        "defaultConsistencyLevel": {
            "type": "string",
            "allowedValues": [
                "Eventual",
                "ConsistentPrefix",
                "Session",
                "BoundedStaleness",
                "Strong"
            ],
            "metadata": {
                "description": "Default consistency level."
            }
        },
        "maxStalenessPrefix": {
            "type": "int",
            "defaultValue": 100000,
            "metadata": {
                "description": "(Conditional, if defaultConsistencyLevel is BoundedStaleness) Max staleness in terms of versions."
            }
        },
        "maxIntervalInSeconds": {
            "type": "int",
            "defaultValue": 300,
            "metadata": {
                "description": "(Conditional, if defaultConsistencyLevel is BoundedStaleness) Max staleness in terms of time."
            }
        },
        "enableMultipleWriteLocations": {
            "type": "bool",
            "defaultValue": false,
            "metadata": {
                "description": "Boolean, for multi-master setup."
            }
        },
        "enableAutomaticFailover": {
            "type": "bool",
            "defaultValue": "[greater(length(parameters('secondaryLocations')), 0)]",
            "metadata": {
                "description": "Boolean, for automatic failover. Defaults to true if secondaryLocations are provided."
            }
        },
        "databases": {
            "type": "array",
            "metadata": {
                "description": "Array of database objects with container definitions."
            }
        },
        "privateEndpointSubnetResourceId": {
            "type": "string",
            "defaultValue": "",
            "metadata": {
                "description": "(Optional) The Resource ID of the subnet to deploy the private endpoint into."
            }
        },
        "privateDnsZoneIdCosmosSql": {
            "type": "string",
            "defaultValue": "",
            "metadata": {
                "description": "(Optional) The Resource ID of the Private DNS Zone for privatelink.<accountName>.documents.azure.com (SQL API)."
            }
        }
    },
    "variables": {
        "deployPrivateEndpoint": "[not(empty(parameters('privateEndpointSubnetResourceId')))]",
        "linkPrivateDnsZoneSql": "[and(variables('deployPrivateEndpoint'), not(empty(parameters('privateDnsZoneIdCosmosSql'))))]",
        "cosmosDbApiVersion": "2021-10-15",
        "privateEndpointApiVersion": "2021-05-01",
        "privateDnsZoneGroupApiVersion": "2021-05-01",
        "primaryLocationObject": {
            "locationName": "[parameters('location')]",
            "failoverPriority": 0
        },
        "allLocations": "[concat(createArray(variables('primaryLocationObject')), parameters('secondaryLocations'))]",
        "privateEndpointNameSql": "[concat(parameters('cosmosDbAccountName'), '-pe-sql')]"
    },
    "resources": [
        {
            "type": "Microsoft.DocumentDB/databaseAccounts",
            "apiVersion": "[variables('cosmosDbApiVersion')]",
            "name": "[parameters('cosmosDbAccountName')]",
            "location": "[parameters('location')]",
            "kind": "GlobalDocumentDB",
            "properties": {
                "consistencyPolicy": {
                    "defaultConsistencyLevel": "[parameters('defaultConsistencyLevel')]",
                    "maxStalenessPrefix": "[if(equals(parameters('defaultConsistencyLevel'), 'BoundedStaleness'), parameters('maxStalenessPrefix'), json('null'))]",
                    "maxIntervalInSeconds": "[if(equals(parameters('defaultConsistencyLevel'), 'BoundedStaleness'), parameters('maxIntervalInSeconds'), json('null'))]"
                },
                "locations": "[variables('allLocations')]",
                "databaseAccountOfferType": "Standard",
                "enableMultipleWriteLocations": "[parameters('enableMultipleWriteLocations')]",
                "enableAutomaticFailover": "[parameters('enableAutomaticFailover')]",
                "publicNetworkAccess": "[if(variables('deployPrivateEndpoint'), 'Disabled', 'Enabled')]",
                "capabilities": []
            }
        },
        {
            "type": "Microsoft.DocumentDB/databaseAccounts/sqlDatabases",
            "apiVersion": "[variables('cosmosDbApiVersion')]",
            "name": "[concat(parameters('cosmosDbAccountName'), '/', parameters('databases')[copyIndex('dbCopyLoop')].name)]",
            "dependsOn": [
                "[resourceId('Microsoft.DocumentDB/databaseAccounts', parameters('cosmosDbAccountName'))]"
            ],
            "copy": {
                "name": "dbCopyLoop", 
                "count": "[length(parameters('databases'))]"
            },
            "properties": {
                "resource": {
                    "id": "[parameters('databases')[copyIndex('dbCopyLoop')].name]" 
                },
                "options": "[if(contains(parameters('databases')[copyIndex('dbCopyLoop')], 'throughput'), createObject('throughput', parameters('databases')[copyIndex('dbCopyLoop')].throughput), createObject())]" 
            }
        },
        {
            "type": "Microsoft.DocumentDB/databaseAccounts/sqlDatabases/containers",
            "apiVersion": "[variables('cosmosDbApiVersion')]",
            "name": "[concat(parameters('cosmosDbAccountName'), '/', parameters('databases')[copyIndex('dbCopyLoop')].name, '/', parameters('databases')[copyIndex('dbCopyLoop')].containers[copyIndex('contCopyLoop')].name)]", 
            "dependsOn": [
                "[resourceId('Microsoft.DocumentDB/databaseAccounts/sqlDatabases', parameters('cosmosDbAccountName'), parameters('databases')[copyIndex('dbCopyLoop')].name)]" 
            ],
            "copy": {
                "name": "contCopyLoop", 
                "count": "[length(parameters('databases')[copyIndex('dbCopyLoop')].containers)]" 
            },
            "properties": {
                "resource": {
                    "id": "[parameters('databases')[copyIndex('dbCopyLoop')].containers[copyIndex('contCopyLoop')].name]", 
                    "partitionKey": {
                        "paths": [
                            "[parameters('databases')[copyIndex('dbCopyLoop')].containers[copyIndex('contCopyLoop')].partitionKeyPath]" 
                        ],
                        "kind": "Hash",
                        "version": "[if(contains(parameters('databases')[copyIndex('dbCopyLoop')].containers[copyIndex('contCopyLoop')], 'partitionKeyVersion'), parameters('databases')[copyIndex('dbCopyLoop')].containers[copyIndex('contCopyLoop')].partitionKeyVersion, json('null'))]" 
                    },
                    "indexingPolicy": "[if(contains(parameters('databases')[copyIndex('dbCopyLoop')].containers[copyIndex('contCopyLoop')], 'indexingPolicy'), parameters('databases')[copyIndex('dbCopyLoop')].containers[copyIndex('contCopyLoop')].indexingPolicy, json('null'))]", 
                    "defaultTtl": "[if(contains(parameters('databases')[copyIndex('dbCopyLoop')].containers[copyIndex('contCopyLoop')], 'defaultTtl'), parameters('databases')[copyIndex('dbCopyLoop')].containers[copyIndex('contCopyLoop')].defaultTtl, json('null'))]" 
                },
                "options": "[if(contains(parameters('databases')[copyIndex('dbCopyLoop')].containers[copyIndex('contCopyLoop')], 'throughput'), createObject('throughput', parameters('databases')[copyIndex('dbCopyLoop')].containers[copyIndex('contCopyLoop')].throughput), createObject())]" 
            }
        },
        {
            "condition": "[variables('deployPrivateEndpoint')]",
            "type": "Microsoft.Network/privateEndpoints",
            "apiVersion": "[variables('privateEndpointApiVersion')]",
            "name": "[variables('privateEndpointNameSql')]",
            "location": "[parameters('location')]",
            "dependsOn": [
                "[resourceId('Microsoft.DocumentDB/databaseAccounts', parameters('cosmosDbAccountName'))]"
            ],
            "properties": {
                "subnet": {
                    "id": "[parameters('privateEndpointSubnetResourceId')]"
                },
                "privateLinkServiceConnections": [
                    {
                        "name": "[variables('privateEndpointNameSql')]",
                        "properties": {
                            "privateLinkServiceId": "[resourceId('Microsoft.DocumentDB/databaseAccounts', parameters('cosmosDbAccountName'))]",
                            "groupIds": [
                                "Sql" 
                            ]
                        }
                    }
                ]
            }
        },
        {
            "condition": "[variables('linkPrivateDnsZoneSql')]",
            "type": "Microsoft.Network/privateEndpoints/privateDnsZoneGroups",
            "apiVersion": "[variables('privateDnsZoneGroupApiVersion')]",
            "name": "[concat(variables('privateEndpointNameSql'), '/default')]",
            "dependsOn": [
                "[resourceId('Microsoft.Network/privateEndpoints', variables('privateEndpointNameSql'))]"
            ],
            "properties": {
                "privateDnsZoneConfigs": [
                    {
                        "name": "privatelink-documents-azure-com", 
                        "properties": {
                            "privateDnsZoneId": "[parameters('privateDnsZoneIdCosmosSql')]"
                        }
                    }
                ]
            }
        }
    ],
    "outputs": {
        "cosmosDbAccountId": {
            "type": "string",
            "value": "[resourceId('Microsoft.DocumentDB/databaseAccounts', parameters('cosmosDbAccountName'))]"
        },
        "cosmosDbEndpoint": {
            "type": "string",
            "value": "[reference(resourceId('Microsoft.DocumentDB/databaseAccounts', parameters('cosmosDbAccountName'))).documentEndpoint]"
        },
        "privateEndpointIdCosmosSql": {
            "condition": "[variables('deployPrivateEndpoint')]",
            "type": "string",
            "value": "[resourceId('Microsoft.Network/privateEndpoints', variables('privateEndpointNameSql'))]"
        },
        "databaseNames": {
            "type": "array",
            "copy": [
                {
                    "name": "databaseNamesOutputLoop",
                    "count": "[length(parameters('databases'))]",
                    "input": "[parameters('databases')[copyIndex('databaseNamesOutputLoop')].name]"
                }
            ]
        },
        "containerDetails": {
            "type": "array",
            "copy": [
                {
                    "name": "containerDetailsDbLoop",
                    "count": "[length(parameters('databases'))]",
                    "input": {
                        "databaseName": "[parameters('databases')[copyIndex('containerDetailsDbLoop')].name]",
                        "containers": "[parameters('databases')[copyIndex('containerDetailsDbLoop')].containers]"
                    }
                }
            ]
        }
    }
}
